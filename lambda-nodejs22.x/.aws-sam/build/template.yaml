AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'lambda-nodejs22.x

  Sample SAM Template for lambda-nodejs22.x

  '
Globals:
  Api:
    Auth:
      ApiKeyRequired: true
Resources:
  BedrockAnalysisFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: bedrock-analysis-function
      CodeUri: BedrockAnalysisFunction
      Handler: app.lambdaHandler
      Runtime: nodejs20.x
      Timeout: 30
      Architectures:
      - x86_64
      Policies:
      - Statement:
        - Effect: Allow
          Action:
          - bedrock:InvokeModel
          - bedrock:InvokeModelWithResponseStream
          - bedrock:Retrieve
          - bedrock:RetrieveAndGenerate
          - bedrock-agent-runtime:RetrieveAndGenerate
          - bedrock-agent:GetKnowledgeBase
          Resource:
          - Fn::Sub: arn:aws:bedrock:${AWS::Region}::foundation-model/*
          - Fn::Sub: arn:aws:bedrock:${AWS::Region}:${AWS::AccountId}:knowledge-base/*
          - Fn::Sub: arn:aws:aoss:${AWS::Region}:${AWS::AccountId}:collection/*
      Events:
        BedrockAnalysis:
          Type: Api
          Properties:
            Path: /analyze
            Method: post
      Environment:
        Variables:
          AWS_SDK_JS_SUPPRESS_MAINTENANCE_MODE_MESSAGE: '1'
          AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1'
          AWS_SDK_JS_DEBUG: 'true'
      Tracing: Active
    Metadata:
      SamResourceId: BedrockAnalysisFunction
  S3unzipFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: s3-unzip-function
      CodeUri: S3unzipFunction
      Handler: app.lambdaHandler
      Runtime: nodejs20.x
      Timeout: 300
      MemorySize: 1024
      Policies:
      - S3ReadPolicy:
          BucketName: '*'
      - S3CrudPolicy:
          BucketName: '*'
      Architectures:
      - x86_64
      Events:
        S3unzip:
          Type: Api
          Properties:
            Path: /s3unzip
            Method: post
    Metadata:
      SamResourceId: S3unzipFunction
Outputs:
  BedrockAnalysisApi:
    Description: API Gateway endpoint URL for Prod stage for Bedrock Analysis function
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/analyze/
  BedrockAnalysisFunction:
    Description: Bedrock Analysis Lambda Function ARN
    Value:
      Fn::GetAtt:
      - BedrockAnalysisFunction
      - Arn
  BedrockAnalysisFunctionIamRole:
    Description: Implicit IAM Role created for Bedrock Analysis function
    Value:
      Fn::GetAtt:
      - BedrockAnalysisFunctionRole
      - Arn
  S3unzipApi:
    Description: API Gateway endpoint URL for Prod stage for S3 Unzip function
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/s3unzip/
  S3unzipFunction:
    Description: S3 Unzip Lambda Function ARN
    Value:
      Fn::GetAtt:
      - S3unzipFunction
      - Arn
  S3unzipFunctionIamRole:
    Description: Implicit IAM Role created for S3 Unzip function
    Value:
      Fn::GetAtt:
      - S3unzipFunctionRole
      - Arn
